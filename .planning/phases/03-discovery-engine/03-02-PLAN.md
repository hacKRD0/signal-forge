---
phase: 03-discovery-engine
type: execute
---

<objective>
Implement customer discovery logic with search, filtering, and enrichment.

Purpose: Create the complete customer discovery pipeline that uses business context to find and enrich potential customer information.
Output: Working customer discovery module that returns 10 qualified customer candidates with complete information.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/03-discovery-engine/03-01-SUMMARY.md
@src/agent/discovery_agent.py
@src/agent/query_builder.py
@src/discovery/web_search.py
@src/models/business_context.py
@src/models/discovery_results.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create customer discovery orchestrator</name>
  <files>src/discovery/customer_discovery.py</files>
  <action>
Create src/discovery/customer_discovery.py:
- Class: CustomerDiscovery
- __init__: Accept DiscoveryAgent, WebSearchEngine, QueryBuilder
- Method: discover(context: BusinessContext, filters: dict = None, target_count: int = 10) -> DiscoveryResult
  - Generate customer queries using QueryBuilder
  - Execute web search using WebSearchEngine
  - Get list of CompanyInfo candidates
  - Filter candidates based on relevance to context
  - Enrich top candidates with additional details
  - Return top N (target_count) candidates as DiscoveryResult
- Method: _filter_by_relevance(candidates: list[CompanyInfo], context: BusinessContext) -> list[CompanyInfo]
  - Use agent to score relevance of each candidate to business context
  - Remove low-scoring candidates (relevance < threshold)
  - Return filtered list
- Method: _enrich_company_info(company: CompanyInfo) -> CompanyInfo
  - Use agent with web search to find additional details (fuller description, precise location)
  - Update CompanyInfo with enriched data
  - Return enriched CompanyInfo
- Add logging for discovery progress (queries generated, results found, filtered, enriched)

Avoid: Don't over-engineer filtering (simple relevance check sufficient). Don't enrich all candidates (only top prospects for efficiency).
  </action>
  <verify>
- src/discovery/customer_discovery.py exists
- Imports: python -c "from src.discovery.customer_discovery import CustomerDiscovery"
- Methods defined: discover, _filter_by_relevance, _enrich_company_info
- discover method returns DiscoveryResult
  </verify>
  <done>CustomerDiscovery orchestrator created with filtering and enrichment</done>
</task>

<task type="auto">
  <name>Task 2: Implement relevance scoring and filtering</name>
  <files>src/discovery/relevance_scorer.py</files>
  <action>
Create src/discovery/relevance_scorer.py:
- Class: RelevanceScorer
- __init__: Accept DiscoveryAgent
- Method: score_customer_relevance(company: CompanyInfo, context: BusinessContext) -> float
  - Create prompt asking agent to score company as potential customer (0.0-1.0 scale)
  - Include context: business products/services, target market, geography
  - Include company: name, description, location, size
  - Agent returns score with brief reasoning
  - Parse score from response
  - Return float score (0.0-1.0)
- Method: batch_score(companies: list[CompanyInfo], context: BusinessContext) -> list[tuple[CompanyInfo, float]]
  - Score multiple companies efficiently
  - Return list of (company, score) tuples
  - Sort by score descending
- Add caching to avoid re-scoring same companies
- Include logging for scores

Threshold: Consider score >= 0.6 as relevant

Avoid: Don't make scoring too complex (agent does the reasoning). Don't score all results (filter obvious mismatches first by query relevance).
  </action>
  <verify>
- src/discovery/relevance_scorer.py exists
- Imports: python -c "from src.discovery.relevance_scorer import RelevanceScorer"
- Methods return appropriate types (float, list[tuple])
- Score is 0.0-1.0 range
  </verify>
  <done>RelevanceScorer implemented with customer relevance logic</done>
</task>

<task type="auto">
  <name>Task 3: Add customer discovery integration and testing</name>
  <files>src/discovery/customer_discovery.py, tests/test_customer_discovery.py</files>
  <action>
Update src/discovery/customer_discovery.py:
- Import RelevanceScorer
- Update _filter_by_relevance to use RelevanceScorer
- Set relevance threshold to 0.6
- Keep top 15-20 candidates after relevance filtering
- Enrich top 10 final candidates

Create tests/test_customer_discovery.py:
- Test: test_customer_discovery_initialization
  - Create CustomerDiscovery instance
  - Verify initialization works
- Mock test: test_discover_workflow_mock
  - Mock QueryBuilder, WebSearchEngine, RelevanceScorer
  - Call discover() with sample context
  - Verify workflow: queries generated → search executed → filtering → enrichment
  - Verify returns DiscoveryResult with companies
- Test: test_relevance_filtering
  - Create mock companies with varied relevance
  - Test filtering keeps high-relevance, removes low-relevance
- Add integration test stub (requires API key, mark as skip in CI)

Avoid: Don't make tests too brittle. Focus on workflow correctness, not exact outputs.
  </action>
  <verify>
- src/discovery/customer_discovery.py uses RelevanceScorer
- tests/test_customer_discovery.py exists
- Tests run: python -m pytest tests/test_customer_discovery.py -v
- Workflow verified through tests
  </verify>
  <done>Customer discovery integrated with relevance scoring and tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CustomerDiscovery class orchestrates full discovery pipeline
- [ ] RelevanceScorer provides customer relevance scoring
- [ ] Filtering and enrichment logic implemented
- [ ] Tests verify workflow correctness
- [ ] Customer discovery returns 10 qualified candidates
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Customer discovery pipeline functional end-to-end
- Relevance filtering ensures quality results
- Ready for partner discovery implementation
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-engine/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Customer Discovery Summary

**Customer discovery pipeline implemented**

## Accomplishments
- Created CustomerDiscovery orchestrator
- Implemented RelevanceScorer for filtering
- Integrated search, filtering, and enrichment pipeline
- Added tests for discovery workflow

## Files Created/Modified
- `src/discovery/customer_discovery.py` - CustomerDiscovery class
- `src/discovery/relevance_scorer.py` - RelevanceScorer class
- `tests/test_customer_discovery.py` - Discovery workflow tests

## Decisions Made
- Relevance threshold set to 0.6 (balance precision/recall)
- Filter to 15-20 candidates before enrichment (efficiency)
- Enrich only top 10 final results (reduce API calls)
- Batch scoring for efficiency

## Issues Encountered
[Document any issues, or "None"]

## Next Step
Ready for 03-03-PLAN.md (Partner discovery logic)
</output>
