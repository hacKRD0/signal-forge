---
phase: 02-agent-core
type: execute
---

<objective>
Implement query formulation logic for customer and partner discovery.

Purpose: Create intelligent query generation that takes business context and user filters to formulate effective web search queries for discovering customers and partners.
Output: Query formulation system that generates targeted search queries based on business context and optional filters.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-agent-core/02-02-SUMMARY.md
@src/models/business_context.py
@src/agent/discovery_agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query formulation templates and logic</name>
  <files>src/agent/query_builder.py</files>
  <action>
Create src/agent/query_builder.py:
- Class: QueryBuilder
- Method: build_customer_queries(context: BusinessContext, filters: dict = None) -> list[str]
  - Generate 3-5 diverse search queries to find potential customers
  - Use context: industry, products, target market, geography
  - Apply filters if provided (geography, industry)
  - Query templates: "[industry] companies in [geography]", "businesses needing [product/service]", "[target market] in [location]"
  - Return list of query strings
- Method: build_partner_queries(context: BusinessContext, filters: dict = None) -> list[str]
  - Generate 3-5 diverse search queries to find potential partners
  - Look for complementary businesses, integration opportunities
  - Query templates: "companies partnering with [industry]", "[complementary industry] businesses in [geography]"
  - Return list of query strings
- Method: refine_query(base_query: str, filters: dict) -> str
  - Add filter constraints to base query (geography, industry)
  - Handle None/empty filters gracefully
  - Return refined query string
- Add docstrings and examples

Avoid: Don't generate duplicate queries. Don't make queries too long (reduces search effectiveness). Don't ignore user filters.
  </action>
  <verify>
- src/agent/query_builder.py exists
- Imports: python -c "from src.agent.query_builder import QueryBuilder"
- Three methods defined with correct signatures
- Methods return appropriate types (list[str] or str)
  </verify>
  <done>QueryBuilder created with customer and partner query generation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate query formulation with DiscoveryAgent</name>
  <files>src/agent/discovery_agent.py</files>
  <action>
Update src/agent/discovery_agent.py:
- Import QueryBuilder
- Update find_customers method:
  - Use QueryBuilder to generate customer queries from context and filters
  - Log generated queries
  - Pass queries to agent as part of discovery prompt
  - Include instruction to use web search tool with these queries
- Update find_partners method:
  - Use QueryBuilder to generate partner queries
  - Log generated queries
  - Pass queries to agent as part of discovery prompt
  - Include instruction to use web search tool
- Add method: _format_discovery_prompt(prompt_template: str, context: BusinessContext, queries: list[str]) -> str
  - Combine system prompt, context info, and queries into final prompt
  - Format clearly for agent consumption
  - Return formatted prompt string

Keep existing extract_context method unchanged

Avoid: Don't send too many queries at once (3-5 is optimal). Don't forget to include context in prompts.
  </action>
  <verify>
- src/agent/discovery_agent.py updated successfully
- Imports QueryBuilder
- find_customers and find_partners use QueryBuilder
- No errors on import: python -c "from src.agent.discovery_agent import DiscoveryAgent"
  </verify>
  <done>DiscoveryAgent integrated with QueryBuilder for intelligent query formulation</done>
</task>

<task type="auto">
  <name>Task 3: Add query formulation tests and examples</name>
  <files>tests/test_query_builder.py, examples/query_examples.py</files>
  <action>
Create tests/test_query_builder.py:
- Test: test_customer_query_generation
  - Create sample BusinessContext
  - Call build_customer_queries()
  - Verify returns list of 3-5 queries
  - Verify queries contain relevant context info
- Test: test_partner_query_generation
  - Create sample BusinessContext
  - Call build_partner_queries()
  - Verify returns list of queries
  - Verify queries differ from customer queries (complementary focus)
- Test: test_query_refinement_with_filters
  - Test refine_query() with geography filter
  - Test refine_query() with industry filter
  - Verify filters applied correctly
- Test: test_empty_filters_handling
  - Call methods with filters=None
  - Verify no errors, queries still generated

Create examples/query_examples.py:
- Example BusinessContext for a SaaS company
- Show generated customer queries
- Show generated partner queries
- Document expected output format
- Add comments explaining query strategy

Avoid: Don't make tests brittle (exact string matching). Test for presence of key terms and structure.
  </action>
  <verify>
- tests/test_query_builder.py exists
- examples/query_examples.py exists
- Tests run without errors: python -m pytest tests/test_query_builder.py -v
- Examples demonstrate query generation clearly
  </verify>
  <done>Tests and examples created for query formulation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] QueryBuilder class created with query generation methods
- [ ] DiscoveryAgent integrated with QueryBuilder
- [ ] Tests verify query generation for customers and partners
- [ ] Examples document expected behavior
- [ ] Filters properly applied to queries
- [ ] Phase 2 complete - agent core ready for discovery engine
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Query formulation generates diverse, targeted queries
- Integration with DiscoveryAgent seamless
- Tests and examples provide clear documentation
- Phase 2 complete - ready for discovery engine implementation
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-core/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Query Formulation Summary

**Query formulation logic implemented and integrated**

## Accomplishments
- Created QueryBuilder for intelligent query generation
- Integrated QueryBuilder with DiscoveryAgent
- Added tests for query generation
- Created examples demonstrating query strategies
- Phase 2 complete: Agent core fully functional

## Files Created/Modified
- `src/agent/query_builder.py` - QueryBuilder class
- `src/agent/discovery_agent.py` - Updated with QueryBuilder integration
- `tests/test_query_builder.py` - Query generation tests
- `examples/query_examples.py` - Usage examples

## Decisions Made
- Generate 3-5 queries per discovery request (balanced coverage)
- Separate query strategies for customers vs partners
- Filter application happens at query level (more targeted)

## Issues Encountered
[Document any issues, or "None"]

## Next Step
Phase 2 complete. Ready for Phase 3: Discovery Engine
</output>
