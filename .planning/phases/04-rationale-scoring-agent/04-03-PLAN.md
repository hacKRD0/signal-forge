---
phase: 04-rationale-scoring-agent
type: execute
---

<objective>
Integrate scoring and rationale generation with discovery pipeline.

Purpose: Connect the scoring and rationale systems to the customer and partner discovery pipelines, producing enriched results with scores and explanations.
Output: Enhanced discovery results that include match scores and detailed rationales for each entity.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/04-rationale-scoring-agent/04-02-SUMMARY.md
@src/discovery/customer_discovery.py
@src/discovery/partner_discovery.py
@src/scoring/match_scorer.py
@src/scoring/rationale_generator.py
@src/models/discovery_results.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance CompanyInfo with scoring and rationale</name>
  <files>src/models/discovery_results.py</files>
  <action>
Update src/models/discovery_results.py:
- Update CompanyInfo dataclass:
  - Add field: match_score: MatchScore = None
  - Add field: rationale: Rationale = None
- Update DiscoveryResult dataclass:
  - Add field: scored: bool = False (indicates if scoring applied)
  - Add field: avg_score: float = 0.0 (average score across all companies)
- Update to_dict() methods to include new fields
- Ensure backward compatibility (fields default to None)

Avoid: Don't break existing code - make new fields optional with defaults.
  </action>
  <verify>
- discovery_results.py updated
- CompanyInfo has match_score and rationale fields
- Imports still work: python -c "from src.models.discovery_results import *"
- Existing tests pass (backward compatible)
  </verify>
  <done>Discovery result models enhanced with scoring and rationale fields</done>
</task>

<task type="auto">
  <name>Task 2: Integrate scoring and rationale into discovery pipelines</name>
  <files>src/discovery/customer_discovery.py, src/discovery/partner_discovery.py</files>
  <action>
Update src/discovery/customer_discovery.py:
- Import MatchScorer, RationaleGenerator
- Add to __init__: scorer: MatchScorer, rationale_gen: RationaleGenerator
- Update discover method:
  - After filtering and before enrichment: score each candidate
  - After enrichment: generate rationale for each
  - Attach MatchScore and Rationale to each CompanyInfo
  - Calculate avg_score for DiscoveryResult
  - Set scored=True on DiscoveryResult
  - Sort final results by overall_score (descending)
- Return top N scored and explained candidates

Update src/discovery/partner_discovery.py:
- Same changes as CustomerDiscovery
- Ensure entity_type="partner" passed to scorer and rationale generator

Avoid: Don't score before filtering (inefficient). Do score after initial filtering, before final selection.
  </action>
  <verify>
- Both discovery classes updated
- Imports include MatchScorer and RationaleGenerator
- discover methods attach scores and rationales to results
- Results sorted by score
- No errors on import
  </verify>
  <done>Discovery pipelines integrated with scoring and rationale generation</done>
</task>

<task type="auto">
  <name>Task 3: Add end-to-end integration tests</name>
  <files>tests/test_discovery_integration.py</files>
  <action>
Create tests/test_discovery_integration.py:
- Mock test: test_customer_discovery_with_scoring
  - Mock all components (search, scoring, rationale generation)
  - Call CustomerDiscovery.discover()
  - Verify DiscoveryResult has scored=True
  - Verify each CompanyInfo has match_score and rationale
  - Verify results sorted by score
  - Verify avg_score calculated
- Mock test: test_partner_discovery_with_scoring
  - Same as customer test but for partners
  - Verify entity_type="partner" used in scoring/rationale
- Test: test_score_based_sorting
  - Create companies with different scores
  - Verify sorting puts highest scores first
- Test: test_avg_score_calculation
  - Multiple companies with known scores
  - Verify avg_score is correct

These tests verify the full pipeline with scoring integration

Avoid: Don't test with real API calls (use mocks). Focus on integration correctness.
  </action>
  <verify>
- tests/test_discovery_integration.py exists
- Tests run: python -m pytest tests/test_discovery_integration.py -v
- Integration verified through tests
- Phase 4 complete
  </verify>
  <done>Integration tests created and passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CompanyInfo model includes match_score and rationale
- [ ] Both discovery pipelines integrate scoring and rationale
- [ ] Results sorted by match score
- [ ] Integration tests verify end-to-end pipeline
- [ ] Phase 4 complete - ready for UI
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Discovery results include scores and rationales
- Scoring and rationale generation seamlessly integrated
- Phase 4 complete - ready for UI development
</success_criteria>

<output>
After completion, create `.planning/phases/04-rationale-scoring-agent/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Discovery Integration Summary

**Scoring and rationale integrated into discovery pipelines**

## Accomplishments
- Enhanced CompanyInfo with match_score and rationale fields
- Integrated MatchScorer and RationaleGenerator into both discovery pipelines
- Results sorted by match score for optimal presentation
- Average score calculation for discovery results
- Comprehensive integration tests

## Files Created/Modified
- `src/models/discovery_results.py` - Added scoring fields
- `src/discovery/customer_discovery.py` - Integrated scoring/rationale
- `src/discovery/partner_discovery.py` - Integrated scoring/rationale
- `tests/test_discovery_integration.py` - Integration tests

## Decisions Made
- Score after initial filtering (efficiency)
- Sort results by score descending (best matches first)
- Backward compatible model changes (optional fields)
- Score and rationale attached to each result

## Issues Encountered
[Document any issues, or "None"]

## Next Step
Phase 4 complete. Ready for Phase 5: UI & Presentation
</output>
