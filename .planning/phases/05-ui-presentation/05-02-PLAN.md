---
phase: 05-ui-presentation
type: execute
---

<objective>
Implement query input interface with filters and discovery trigger.

Purpose: Create the user interface for entering discovery requests (customer or partner) with optional filters, and trigger the discovery process.
Output: Query input form with filters and "Generate" button that initiates discovery.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-presentation/05-01-SUMMARY.md
@app.py
@src/discovery/customer_discovery.py
@src/discovery/partner_discovery.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query input and filter components</name>
  <files>src/ui/components.py</files>
  <action>
Update src/ui/components.py:
- Function: render_discovery_input() -> tuple[str, dict]
  - Radio button: "Discovery Type" - Customer or Partner
  - Text input: "Natural Language Request" (optional, for future use)
  - Filter section in st.expander("Optional Filters"):
    - Multiselect: Geography (continents/regions: North America, Europe, Asia, etc.)
    - Multiselect: Industry (common industries: Technology, Healthcare, Finance, etc.)
  - Return tuple: (entity_type: str, filters: dict)
  - Default filters to empty dict if none selected
- Add clear labels and help text

Avoid: Don't overcomplicate filters (geography and industry sufficient). Don't require filters (optional).
  </action>
  <verify>
- render_discovery_input() function exists
- Returns tuple (entity_type, filters)
- UI shows discovery type selector and filter options
- Filters are optional
  </verify>
  <done>Discovery input and filter components created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate discovery engine with UI</name>
  <files>app.py, src/ui/discovery_runner.py</files>
  <action>
Create src/ui/discovery_runner.py:
- Function: run_discovery(entity_type: str, context: BusinessContext, filters: dict) -> DiscoveryResult
  - Initialize all required components (DiscoveryAgent, QueryBuilder, WebSearchEngine, etc.)
  - If entity_type == "customer": use CustomerDiscovery
  - If entity_type == "partner": use PartnerDiscovery
  - Call discover() with context and filters
  - Return DiscoveryResult
  - Add error handling
  - Log discovery process

Update app.py:
- Import discovery_runner, render_discovery_input
- Add discovery input section (after context summary)
- Only show if context exists
- Get entity_type and filters from render_discovery_input()
- Add "Generate" button
- On click:
  - Show spinner "Discovering {entity_type}s..."
  - Call run_discovery()
  - Store result in appropriate session state (customers or partners)
  - Show success message: "Found N {entity_type}s"

Avoid: Don't run discovery on every rerun (button click only). Don't lose previous results (store both customers and partners in session state).
  </action>
  <verify>
- src/ui/discovery_runner.py exists
- app.py integrates discovery
- "Generate" button triggers discovery
- Spinner shows during processing
- Results stored in session state
- streamlit run app.py shows full flow
  </verify>
  <done>Discovery engine integrated with UI and generate button</done>
</task>

<task type="auto">
  <name>Task 3: Add error handling and user feedback</name>
  <files>app.py, src/ui/error_handler.py</files>
  <action>
Create src/ui/error_handler.py:
- Function: handle_discovery_error(error: Exception) - Display user-friendly error messages
  - Check error type (API error, parsing error, network error)
  - Show appropriate st.error() message
  - Provide actionable guidance (check API key, retry, etc.)
  - Log full error details

Update app.py:
- Wrap discovery call in try/except
- On error: call handle_discovery_error()
- Add validation before discovery:
  - Check context exists
  - Check API key configured (read from config)
  - Show warning if preconditions not met
- Add info messages for user:
  - "Upload documents first"
  - "Configure API key in .env"
  - "Processing may take 30-60 seconds"

Avoid: Don't show raw error traces to user (log them, show friendly message). Don't crash app on errors.
  </action>
  <verify>
- error_handler.py exists
- Errors display user-friendly messages
- Validation prevents invalid states
- App doesn't crash on errors
- User gets clear guidance on what to do
  </verify>
  <done>Error handling and user feedback implemented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Discovery input shows entity type selector and filters
- [ ] "Generate" button triggers discovery
- [ ] Discovery results stored in session state
- [ ] Error handling prevents crashes
- [ ] User feedback guides proper usage
- [ ] Ready for results display
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Query input interface functional
- Filters apply to discovery process
- Discovery triggered by "Generate" button
- Errors handled gracefully with user guidance
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-presentation/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Query Input & Filters Summary

**Discovery input interface with filters and generation**

## Accomplishments
- Created discovery input component (entity type, filters)
- Integrated discovery engine with UI
- "Generate" button triggers customer/partner discovery
- Error handling with user-friendly messages
- Validation prevents invalid states
- User feedback and guidance

## Files Created/Modified
- `src/ui/components.py` - Added render_discovery_input
- `src/ui/discovery_runner.py` - Discovery integration
- `src/ui/error_handler.py` - Error handling
- `app.py` - Discovery input and generation flow

## Decisions Made
- Two filters (geography, industry) balance simplicity and utility
- Entity type selector (customer vs partner) clear and simple
- Generate button explicit (not automatic)
- Separate session state for customer and partner results

## Issues Encountered
[Document any issues, or "None"]

## Next Step
Ready for 05-03-PLAN.md (Results table display)
</output>
